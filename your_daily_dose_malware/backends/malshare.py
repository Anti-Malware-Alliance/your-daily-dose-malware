import os

import requests
from dotenv import load_dotenv

load_dotenv()


def scrap_malshare():
    api_key = os.getenv("MALSHARE_API_KEY")
    print(api_key)
    try:
        response = requests.post(
            f"https://malshare.com//api.php?api_key={api_key}&action=getlist",
            verify=True,
        )
        response.raise_for_status()
        hashes = response.json()
    except Exception as err:
        raise err
    try:
        sha256_ids = [hashe["sha256"] for hashe in hashes]
        for sha256_id in sha256_ids:
            with requests.post(
                "https://malshare.com//api.php",
                params={
                    "api_key": api_key,
                    "action": "getfile",
                    "sha256": sha256_id},
                stream=True,
                verify=True,
            ) as response:
                response.raise_for_status()
                with open(f"malware_{sha256_id[:4]}.zip", "wb") as f:
                    for response in response.iter_content(chunk_size=1024):
                        f.write(response)
    except Exception as err:
        raise err


scrap_malshare()
