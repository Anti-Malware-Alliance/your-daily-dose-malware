import click
from commands.scraper import scraper
import requests
from dotenv import load_dotenv
import os

load_dotenv()
@click.command(help="dowloading malwares in zip file  by using api from 'https://mb-api.abuse.ch/api/v1/' then write t")
@click.argument('sha256_names', type=click.File('r'),)
def run_scrapper(sha256_names):
    """Download all malwares in zip file with theirs sha256 hash by using api from 'https://mb-api.abuse.ch/api/v1/' 
    sha256_names: list of sha256 hashes
    """
    data = {
        'query':'get_file',
        'sha256_hash':''  

    }
    headers = {
        'API-KEY':os.getenv('API_KEY')
    }
    for sha256_hash in sha256_names.read().splitlines()[:2]: # just to test only 2 sha256 hashes
        data['sha256_hash'] = sha256_hash
        response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, headers=headers)
        f = open(f'malware_{sha256_hash[:4]}.zip', 'wb')
        f.write(response.content)
        f.close()

if __name__ == '__main__':
    scraper.add_command(run_scrapper)
    scraper()
